<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>4人支援組み合わせ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">4人支援 組み合わせリスト</h1>

        <!-- 含む -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-4">
                <select id="filter-include-select" class="form-select">
                    <option value="" disabled selected>キャラを選んでください</option>
                    <option>イサドラ</option>
                    <option>ウィル</option>
                    <option>ヴァイダ</option>
                    <option>エリウッド</option>
                    <option>エルク</option>
                    <option>オズイン</option>
                    <option>カアラ</option>
                    <option>カナス</option>
                    <option>カレル</option>
                    <option>ギィ</option>
                    <option>ガイツ</option>
                    <option>ケント</option>
                    <option>ジャファル</option>
                    <option>セイン</option>
                    <option>セーラ</option>
                    <option>ダーツ</option>
                    <option>ドルカス</option>
                    <option>ニノ</option>
                    <option>ニニアン</option>
                    <option>バアトル</option>
                    <option>ハーケン</option>
                    <option>パント</option>
                    <option>ヒース</option>
                    <option>ファリナ</option>
                    <option>フィオーラ</option>
                    <option>フロリーナ</option>
                    <option>プリシラ</option>
                    <option>ヘクトル</option>
                    <option>ホークアイ</option>
                    <option>マーカス</option>
                    <option>マシュー</option>
                    <option>マリナス</option>
                    <option>ラガルト</option>
                    <option>ラス</option>
                    <option>リン</option>
                    <option>レイヴァン</option>
                    <option>レナート</option>
                    <option>レベッカ</option>
                    <option>ルイーズ</option>
                    <option>ルセア</option>
                    <option>ロウエン</option>
                    <option>ワレス</option>
                </select>
            </div>
            <div class="col-auto">
                <span class="fw-bold">を含む</span>
            </div>
        </div>

        <!-- 含まない -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-4">
                <select id="filter-exclude-select" class="form-select">
                    <option value="" disabled selected>キャラを選んでください</option>
                    <option>イサドラ</option>
                    <option>ウィル</option>
                    <option>ヴァイダ</option>
                    <option>エリウッド</option>
                    <option>エルク</option>
                    <option>オズイン</option>
                    <option>カアラ</option>
                    <option>カナス</option>
                    <option>カレル</option>
                    <option>ギィ</option>
                    <option>ガイツ</option>
                    <option>ケント</option>
                    <option>ジャファル</option>
                    <option>セイン</option>
                    <option>セーラ</option>
                    <option>ダーツ</option>
                    <option>ドルカス</option>
                    <option>ニノ</option>
                    <option>ニニアン</option>
                    <option>バアトル</option>
                    <option>ハーケン</option>
                    <option>パント</option>
                    <option>ヒース</option>
                    <option>ファリナ</option>
                    <option>フィオーラ</option>
                    <option>フロリーナ</option>
                    <option>プリシラ</option>
                    <option>ヘクトル</option>
                    <option>ホークアイ</option>
                    <option>マーカス</option>
                    <option>マシュー</option>
                    <option>マリナス</option>
                    <option>ラガルト</option>
                    <option>ラス</option>
                    <option>リン</option>
                    <option>レイヴァン</option>
                    <option>レナート</option>
                    <option>レベッカ</option>
                    <option>ルイーズ</option>
                    <option>ルセア</option>
                    <option>ロウエン</option>
                    <option>ワレス</option>
                </select>
            </div>
            <div class="col-auto">
                <span class="fw-bold">を含まない</span>
            </div>
        </div>

        <div class="mb-4" id="filter-tags">
            <!-- 選んだキャラがここに表示される -->
        </div>

        <table id="supportTable" class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>1人目</th>
                    <th>2人目</th>
                    <th>3人目</th>
                    <th>4人目</th>
                </tr>
            </thead>
            <tbody>
                {% for group in results %}
                <tr>
                    {% for name in group %}
                    <td>{{ name }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if not results %}
        <div class="alert alert-warning text-center">該当する組み合わせが見つかりませんでした。</div>
        {% endif %}
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        const includeFilters = [];
        const excludeFilters = [];

        function renderTags() {
            const container = $('#filter-tags');
            container.empty();

            // 含む（青）
            includeFilters.forEach((name, idx) => {
                const tag = $(`
              <span class="badge bg-primary me-2">
                ${name}
                <button type="button" class="btn-close btn-close-white btn-sm ms-1" data-type="include" data-index="${idx}"></button>
              </span>
            `);
                container.append(tag);
            });

            // 含まない（赤）
            excludeFilters.forEach((name, idx) => {
                const tag = $(`
              <span class="badge bg-danger me-2">
                ${name}
                <button type="button" class="btn-close btn-close-white btn-sm ms-1" data-type="exclude" data-index="${idx}"></button>
              </span>
            `);
                container.append(tag);
            });

            // 削除ボタン処理
            $('.btn-close').click(function () {
                const type = $(this).data('type');
                const idx = $(this).data('index');
                if (type === 'include') includeFilters.splice(idx, 1);
                if (type === 'exclude') excludeFilters.splice(idx, 1);
                renderTags();
                $('#supportTable').DataTable().draw();
            });
        }

        // DataTables カスタムフィルター関数
        $.fn.dataTable.ext.search.push(function (settings, data) {
            const rowText = data.join(" ");

            // AND検索: 含むキャラすべてを含んでいるか
            if (!includeFilters.every(name => rowText.includes(name))) return false;

            // 含まないキャラが1人でも含まれていたら非表示
            if (excludeFilters.some(name => rowText.includes(name))) return false;

            return true;
        });

        $(document).ready(function () {
            const table = $('#supportTable').DataTable({
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json"
                }
            });

            // 含むプルダウン
            $('#filter-include-select').on('change', function () {
                const name = $(this).val();
                if (name && !includeFilters.includes(name)) {
                    includeFilters.push(name);
                    renderTags();
                    table.draw();
                }
                $(this).val(""); // リセット
            });

            // 含まないプルダウン
            $('#filter-exclude-select').on('change', function () {
                const name = $(this).val();
                if (name && !excludeFilters.includes(name)) {
                    excludeFilters.push(name);
                    renderTags();
                    table.draw();
                }
                $(this).val(""); // リセット
            });
        });
    </script>
</body>

</html>